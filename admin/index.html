<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Admin – BookVault</title>
    <!-- Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Charge le CMS depuis jsDelivr puis fallback unpkg si besoin -->
    <script
      src="https://cdn.jsdelivr.net/npm/netlify-cms@^2.0.0/dist/netlify-cms.js"
      onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';document.head.appendChild(s);})();">
    </script>

    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .msg{max-width:760px;margin:15vh auto 0;padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
      .muted{color:#6b7280}
    </style>
  </head>
  <body>
    <div id="fallback" class="msg" style="display:none">
      <h2>Impossible de charger Netlify CMS</h2>
      <p class="muted">Vérifie que <code>/admin/config.yml</code> est accessible et réessaie en navigation privée.</p>
    </div>

    <script>
      // On désactive l'auto-init et on lance CMS.init() nous-même
      window.CMS_MANUAL_INIT = true;

      function initCMS() {
        if (window.CMS) {
          try {
            CMS.init({
              config: {
                load_config_file: true,
                path: "/admin/config.yml"
              }
            });
          } catch (e) {
            document.getElementById('fallback').style.display = 'block';
            console.error('CMS.init error', e);
          }
        } else {
          // Attend que le script du CMS soit chargé
          setTimeout(initCMS, 300);
        }
      }
      // Sécurité : si au bout de 6s rien n'est chargé, on montre un message
      setTimeout(function(){
        if (!window.CMS) document.getElementById('fallback').style.display = 'block';
      }, 6000);

      initCMS();
    </script>
  </body>
</html>
